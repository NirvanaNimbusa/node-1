stages:
  - prepare
  - test
  - pre-release
  - build-ios

variables:
  BUILD_COMMIT: $CI_COMMIT_SHORT_SHA
  BUILD_BRANCH: $CI_COMMIT_REF_NAME
  BUILD_BRANCH_SAFE: $CI_COMMIT_REF_SLUG
  BUILD_TAG: $CI_COMMIT_TAG
  BUILD_NUMBER: $CI_PIPELINE_ID
  GITHUB_OWNER: mysteriumnetwork
  GITHUB_REPO: node
  GITHUB_SNAPSHOT_REPO: node-builds

  GO_PACKAGE: github.com/mysteriumnetwork/node
  GIT_CLONE_PATH: /home/gitlab-runner/go/src/$GO_PACKAGE
  GOFLAGS: "-count=1" # Supersedes GOCACHE=off, see: https://github.com/golang/go/issues/29378#issuecomment-449383809

before_script:
  # load vars generated by prepare:env
  - source build/env.sh
  - echo "${DOCKERHUB_PASSWORD}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin || true

after_script:
  # docker based jobs leave files owned by root
  - sudo chown -R gitlab-runner:gitlab-runner $GOPATH

env:
  stage: prepare
  tags: [go]
  artifacts:
    paths: [build/env.sh]
  before_script:
    - ''
  script: go run mage.go -v GenerateEnvFile

checks:
  stage: test
  tags: [go]
  script:
    - go run mage.go -v Check

test:
  stage: test
  tags: [go]
  script:
    - go run mage.go -v TestWithCoverage
    - touch $CI_PROJECT_DIR/success
  after_script:
    - |
      if [ -e success ]; then
        bash <(curl -s https://codecov.io/bash)
      fi

#  stage: test
#  tags: [go,high_performance]
#  script: go run mage.go -v TestE2EBasic
#
#test-e2e-nat:
#  stage: test
#  tags: [go,high_performance]
#  script: go run mage.go -v TestE2ENAT

# with the new payments, we're making a breaking change, so no compatibility for now
# test-e2e-compatibility:
#   stage: test
#   tags: [go,high_performance]
#   script: go run mage.go -v TestE2ECompatibility

test-install-script:
  stage: test
  tags: [go,dedicated]
  script: go run mage.go -v TestInstallScript
  only:
    - master

create-bucket:
  stage: pre-release
  tags: [go]
  script: go run mage.go -v MakeBucket

package:ios:
  stage: build-ios
  tags: [go]
  script: go run mage.go -v PackageIOS
  artifacts:
    paths:
      [build/package]

